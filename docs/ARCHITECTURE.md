# 🏗️ Архитектура системы

## Обзор

HSE ML Contrast Checker следует **модульной, слоистой архитектуре**, разработанной для поддерживаемости, тестируемости и расширяемости.

## Высокоуровневая архитектура

```
┌───────────────────────────────────────────────────┐
│         Пользовательские интерфейсы                │
│  ┌──────────────┐  ┌────────────────────────┐     │
│  │ CLI (click)  │  │ Web UI (FastAPI)       │     │
│  └──────┬───────┘  └────────┬───────────────┘     │
└─────────┼──────────────────┼────────────────────┘
          │                  │
          │    ┌─────────────▼──────────────┐
          │    │  webapp.py (FastAPI)       │
          │    │  • REST API endpoints      │
          │    │  • Selenium интеграция     │
          │    │  • Управление сессиями     │
          │    └─────────────┬──────────────┘
          │                  │
┌─────────▼──────────────────▼─────────────────────┐
│              Слой приложения                      │
│  ┌─────────────────────────────────────────┐     │
│  │     contrast_checker.py                 │     │
│  │  • Оркестрирует рабочий процесс          │     │
│  │  • Координирует между модулями           │     │
│  │  • Обрабатывает JSON I/O                 │     │
│  └─────────────────────────────────────────┘     │
└──┬────────────┬────────────┬────────────┬────────┘
   │            │            │            │
┌──▼──────┐ ┌──▼──────┐ ┌──▼──────┐ ┌──▼──────┐
│ Парсер  │ │  HTML   │ │Анализ.  │ │  WCAG   │
│ цветов  │ │ парсер  │ │изображ. │ │Калькул. │
│         │ │         │ │  (ML)   │ │         │
└─────────┘ └─────────┘ └─────────┘ └─────────┘
   Доменный слой (Бизнес-логика)

┌─────────────────────────────────────────────────┐
│           Вспомогательные модули                 │
│  ┌──────────────┐  ┌────────────────────────┐   │
│  │ Batch        │  │ Slide Scraper          │   │
│  │ Analyzer     │  │ (Basic + Advanced)     │   │
│  └──────────────┘  └────────────────────────┘   │
└─────────────────────────────────────────────────┘
```

## Разбор по слоям

### 1. Слой представления

**Модуль**: `cli.py`

**Обязанности**:
- Парсинг аргументов командной строки
- Валидация входных файлов
- Отображение прогресса и результатов
- Обработка форматирования ошибок

**Технология**: библиотека `click`

**Ключевые функции**:
- `main()`: Точка входа для CLI

### 2. Слой приложения

**Модуль**: `contrast_checker.py`

**Обязанности**:
- Оркестрация рабочего процесса анализа
- Координация между доменными модулями
- Агрегация результатов
- Обработка JSON сериализации

**Ключевые функции**:
- `analyze_slide()`: Главный оркестратор анализа
- `determine_effective_background()`: Определение цвета фона
- `analyze_entity_contrast()`: Анализ для каждого элемента

### 3. Доменный слой

#### 3.1 Парсер цветов (`color_parser.py`)

**Назначение**: Парсинг и манипуляции с CSS цветами

**Ключевые классы**:
- `RGBA`: Представление цвета с альфа-каналом

**Ключевые функции**:
- `parse_css_color()`: Парсинг hex/rgb/rgba/hsl/hsla
- `blend_over()`: Альфа-композитинг
- `hsl_to_rgb()`: Конвертация цветовых пространств
- `parse_font_size_px()`: Нормализация размера шрифта

**Зависимости**: Нет (чистый Python)

#### 3.2 HTML парсер (`html_parser.py`)

**Назначение**: Извлечение текстовых элементов из HTML

**Ключевые функции**:
- `extract_entities()`: Поиск всех текстовых элементов
- `extract_font_info()`: Парсинг свойств шрифта
- `extract_geometry()`: Парсинг позиционирования

**Зависимости**: `BeautifulSoup4`, `lxml`

**Паттерн проектирования**: Стратегия (разные парсеры для разных HTML структур)

#### 3.3 Анализатор изображений (`image_analyzer.py`)

**Назначение**: ML-извлечение доминирующих цветов

**Ключевые функции**:
- `dominant_colors_mediancut()`: Алгоритм median-cut
- `dominant_colors_kmeans()`: K-means кластеризация
- `analyze_image_region()`: Анализ конкретного региона

**Зависимости**: `Pillow`, `scikit-learn`, `numpy`

**Паттерн проектирования**: Стратегия (взаимозаменяемые ML алгоритмы)

#### 3.4 WCAG калькулятор (`wcag.py`)

**Назначение**: Расчеты контрастности WCAG 2.2

**Ключевые функции**:
- `relative_luminance()`: Расчет яркости цвета
- `contrast_ratio()`: Расчет коэффициента контрастности
- `classify_wcag()`: Определение уровня WCAG
- `suggest_fixes()`: Генерация рекомендаций по улучшению

**Зависимости**: Нет (чистый Python + math)

**Паттерн проектирования**: Утилитарные функции (без состояния)

### 4. Слой отчетности

**Модуль**: `report_generator.py`

**Обязанности**:
- Генерация HTML отчетов
- Визуализация цветовых комбинаций
- Форматирование WCAG значков
- Представление рекомендаций

**Вывод**: Статический HTML файл

## Поток данных

```
1. Пользовательский ввод (JSON + опциональное изображение)
   ↓
2. CLI валидирует и парсит аргументы
   ↓
3. contrast_checker.analyze_slide()
   ├─→ Загрузка JSON данных слайда
   ├─→ Загрузка фонового изображения (если есть)
   ├─→ Определение эффективного цвета фона
   │   ├─→ Если base_color: parse_css_color()
   │   └─→ Если изображение: dominant_colors_*(image, method)
   ├─→ Извлечение HTML элементов
   │   └─→ html_parser.extract_entities(html)
   └─→ Для каждого элемента:
       ├─→ Извлечение информации о шрифте
       ├─→ Извлечение цветов текста (взвешенных)
       ├─→ Расчет контрастности
       │   └─→ wcag.contrast_ratio(text, bg)
       ├─→ Классификация уровней WCAG
       │   └─→ wcag.classify_wcag(ratio, size, weight)
       └─→ Генерация рекомендаций (если провал)
           └─→ wcag.suggest_fixes(...)
   ↓
4. Агрегация результатов
   ↓
5. Вывод JSON и HTML отчетов
```

## Зависимости модулей

```
cli.py
  └─→ contrast_checker.py
      ├─→ color_parser.py
      ├─→ html_parser.py
      │   └─→ color_parser.py
      ├─→ image_analyzer.py
      └─→ wcag.py

report_generator.py
  (нет внутренних зависимостей)
```

**Правила зависимостей**:
- ✅ Доменные модули могут зависеть от других доменных модулей
- ✅ Слой приложения может зависеть от доменного слоя
- ✅ Слой представления может зависеть от слоя приложения
- ❌ Нет циклических зависимостей
- ❌ Доменные модули НЕ должны зависеть от слоя приложения

## Паттерны проектирования

### Паттерн Стратегия

Используется для **выбора ML алгоритма**:

```python
if method == 'kmeans':
    colors = dominant_colors_kmeans(img, k=k)
else:
    colors = dominant_colors_mediancut(img, k=k)
```

**Преимущества**:
- Легко добавлять новые ML алгоритмы
- Переключение алгоритма во время выполнения
- Тестируемость в изоляции

### Паттерн Фабрика

Неявно в `parse_css_color()`:

```python
def parse_css_color(color: str) -> RGBA:
    if color.startswith('#'):
        # Парсер HEX
    elif 'rgb' in color:
        # Парсер RGB
    elif 'hsl' in color:
        # Парсер HSL
```

**Преимущества**:
- Единая точка входа для всех форматов цветов
- Расширяемость для новых форматов

### Паттерн Фасад

`contrast_checker.analyze_slide()` действует как **фасад**:

```python
def analyze_slide(...):
    # Скрывает сложность координации:
    # - Парсинг цветов
    # - Парсинг HTML
    # - ML анализ
    # - Расчет WCAG
```

**Преимущества**:
- Простой API для сложных операций
- Уменьшенная связность в слое CLI

## Стратегия тестирования

### Модульные тесты

Каждый доменный модуль имеет независимые модульные тесты:

- `test_color_parser.py`: Чистые функции, без зависимостей
- `test_wcag.py`: Математические расчеты
- `test_html_parser.py`: Использование BeautifulSoup
- `test_image_analyzer.py`: ML алгоритмы (с фикстурами)

**Цель покрытия**: > 80%

### Интеграционные тесты

Тестирование взаимодействий между модулями:

- Парсинг цветов → расчет WCAG
- Парсинг HTML → извлечение шрифта
- Анализ изображения → определение фона

### Сквозные тесты

Полные вызовы CLI с примерами файлов:

```bash
python -m src.cli --slide-json examples/slide_color_bg.json
```

## Обработка ошибок

### Распространение ошибок

```
CLI
 └─→ перехват и форматирование всех ошибок
     └─→ Слой приложения
         └─→ выброс специфичных исключений
             └─→ Доменный слой
                 └─→ выброс ValueError/TypeError
```

### Типы ошибок

- `FileNotFoundError`: Отсутствующие входные файлы
- `ValueError`: Невалидный JSON, некорректные цвета
- `TypeError`: Неверные типы параметров

## Соображения производительности

### Узкие места

1. **Загрузка изображений**: Смягчается изменением размера до 150x150
2. **K-means**: Медленнее median-cut; пользователь выбирает
3. **Парсинг HTML**: BeautifulSoup достаточно быстр для слайдов

### Стратегии оптимизации

- **Ленивая загрузка**: Загрузка изображений только при необходимости
- **Кэширование**: Возможно кэширование доминирующих цветов по хешу изображения (в будущем)
- **Параллельная обработка**: Возможен параллельный анализ элементов (в будущем)

## Точки расширения

### Добавление новых форматов цветов

Добавить в `parse_css_color()` в `color_parser.py`:

```python
if color.startswith('lab('):
    return parse_lab_color(color)
```

### Добавление новых ML алгоритмов

Добавить новую функцию в `image_analyzer.py`:

```python
def dominant_colors_gmm(img, k=5):
    # Реализация Gaussian Mixture Model
    ...
```

Обновить выбор в CLI в `cli.py`.

### Добавление новых версий WCAG

Обновить пороги в `wcag.py`:

```python
def classify_wcag_3_0(ratio, font_size, font_weight):
    # Расчеты WCAG 3.0 (APCA)
    ...
```

## Развертывание

### Docker архитектура

```
┌─────────────────────────┐
│  Этап 1: Builder        │
│  • Установка зависим.   │
│  • Без исходного кода   │
└───────────┬─────────────┘
            │
            │ Копирование /root/.local
            ▼
┌─────────────────────────┐
│  Этап 2: Runtime        │
│  • Копирование зависим. │
│  • Копирование src+ex.  │
│  • Легковесный образ    │
└─────────────────────────┘
```

**Преимущества**:
- Меньший финальный образ
- Нет инструментов сборки в продакшене
- Воспроизводимые сборки

### Монтирование директорий

```yaml
volumes:
  - ./examples:/app/examples:ro  # Только чтение
  - ./output:/app/output         # Чтение-запись
```

## Реализованные компоненты

### Веб-приложение (FastAPI)

**Модуль**: `webapp.py`

**Обязанности**:
- REST API endpoints для анализа
- Интеграция с Selenium для извлечения слайдов из URL
- Обработка загрузки HTML файлов
- Генерация сессий и управление результатами
- Статический файловый сервер для результатов

**Архитектура**:
```
┌─────────────────┐
│  Веб-клиент     │
│  (Browser UI)   │
└────────┬────────┘
         │ HTTP
    ┌────▼──────────────────┐
    │  FastAPI Application  │
    │  (webapp.py)          │
    └────┬──────────┬───────┘
         │          │
    ┌────▼────┐ ┌──▼──────────┐
    │Scraper  │ │Contrast     │
    │(Selenium)│ │Checker      │
    └─────────┘ └─────────────┘
```

**API Endpoints**:
- `GET /` - Главная страница
- `GET /health` - Health check
- `POST /api/analyze-url` - Анализ по URL
- `POST /api/analyze-file` - Анализ файла
- `GET /api/result/{session_id}/{filename}` - Получение результатов

### Batch Analyzer

**Модуль**: `batch_analyzer.py`

**Обязанности**:
- Массовая обработка множества слайдов
- Агрегация результатов
- Поддержка Docker для изоляции
- Генерация сводных отчетов

### Slide Scraper

**Базовый scraper** (`slide_scraper.py`):
- Извлечение слайдов из статических HTML
- Парсинг Diaclass презентаций
- Быстрая обработка

**Продвинутый scraper** (`slide_scraper_advanced.py`):
- Поддержка Selenium для динамических сайтов
- Извлечение из URL
- Обработка JavaScript-презентаций
- Извлечение отдельных слайдов по индексу

## Будущие улучшения архитектуры

1. **Система плагинов**: Динамическая загрузка пользовательских ML алгоритмов
2. **База данных**: Хранение исторических результатов и аналитика
3. **Асинхронная обработка**: Очередь задач для длительных анализов
4. **Кэширование**: Redis для кэширования результатов повторных анализов
5. **Расширенный веб UI**: React/Vue SPA с реал-тайм обновлениями

---

**Сопровождающий**: HSE ML Team
